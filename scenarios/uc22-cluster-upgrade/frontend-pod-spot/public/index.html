<!DOCTYPE html>
<html>
<head>
  <title>PodSpot</title>
  <meta charset="utf-8">
  <style>
    :root {
      --accent: #1d72b8;
      --bg: #f5f7fa;
      --header: #ffffffcc;
      --shadow: 0 2px 12px #0001;
      --error: #e63946;
      --font: 'Segoe UI', 'Arial', sans-serif;
    }
    html, body {
      background: var(--bg);
      font-family: var(--font);
      margin: 0; padding: 0;
    }
    .container {
      max-width: 1200px;
      min-width: 340px;
      margin: 2.5em auto 1em auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 2.5em 2em 2em 2em;
    }
    h2 {
      margin-top: 0;
      font-size: 2.1em;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--accent);
      text-shadow: 0 1px 0 #fff;
      margin-bottom: 0.2em;
    }
    h4 {
      margin: 0 0 1em 0;
      color: #446;
      font-weight: 400;
      font-size: 1.1em;
      letter-spacing: 0.01em;
    }
    #button-bar {
      margin-bottom: 1.4em;
    }
    .button {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      padding: 0.6em 1.4em;
      font-size: 1em;
      margin-right: 1em;
      box-shadow: 0 2px 6px #0002;
      cursor: pointer;
      transition: background 0.18s;
      outline: none;
    }
    .button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .button:hover:enabled {
      background: #174c7c;
    }
    #backend-url-form {
      display: flex;
      align-items: center;
      gap: 1em;
      margin-bottom: 1.8em;
      flex-wrap: wrap;
    }
    #backend-url-input {
      font-size: 1.08em;
      padding: 0.5em 0.8em;
      border: 1.4px solid #aaa;
      border-radius: 5px;
      width: 360px;
      max-width: 92vw;
    }
    .timestamp {
      color: #888;
      font-size: 0.96em;
      float: right;
      font-style: italic;
      margin-bottom: 0.8em;
    }
    .timer-bar {
      font-size: 1.1em;
      color: #222;
      background: #eaf4fa;
      padding: 0.5em 1em;
      border-radius: 7px;
      display: inline-block;
      margin-bottom: 1em;
      margin-right: 1em;
      letter-spacing: 0.03em;
      font-weight: 500;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--header);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      table-layout: auto;
    }
    th {
      background: var(--accent);
      color: #fff;
      font-size: 1.03em;
      letter-spacing: 0.02em;
      font-weight: 700;
      padding: 12px 8px;
      border-bottom: 2px solid #ddd4;
      user-select: none;
    }
    td {
      padding: 11px 8px;
      font-size: 1.04em;
      border-bottom: 1px solid #eee;
      word-break: break-word;
    }
    tr:nth-child(even) td {
      background: #f2f8fc;
    }
    td.mono, th.mono { font-family: 'Fira Mono', 'Consolas', monospace; font-size: 0.99em;}
    td.error { color: var(--error); font-weight: bold;}
    .hidden { display: none !important; }
    @media (max-width: 700px) {
      .container { padding: 1em; }
      th, td { font-size: 0.96em; }
      #backend-url-input { width: 99vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PodSpot</h2>
    <h4>See exactly where your OpenShift workloads are running, live. Perfect for tracking pods and nodes during upgrades or rescheduling.</h4>
    <form id="backend-url-form">
      <label for="backend-url-input"><b>Backend API URL:</b></label>
      <input type="url" id="backend-url-input" placeholder="https://..." required />
      <button class="button" id="url-save-btn" type="submit">Save</button>
      <button class="button" id="url-reset-btn" type="button">Reset URL</button>
    </form>
    <div class="timer-bar">
      Timer: <span id="timer-value">00:00:00</span>
    </div>
    <div id="button-bar">
      <button class="button" id="start-btn">Start</button>
      <button class="button" id="pause-btn">Pause</button>
      <button class="button" id="reset-btn">Reset</button>
    </div>
    <div class="timestamp" id="table-updated"></div>
    <table id="statustable">
      <thead>
        <tr>
          <th>Count</th>
          <th>Time</th>
          <th class="mono">Pod Name</th>
          <th class="mono">Node Name</th>
          <th>Response Code</th>
          <th>Latency (ms)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    // === CONFIGURATION ===
    const STORAGE_KEY = 'resiliency-demo-records-v2';
    const BACKEND_URL_KEY = 'resiliency-demo-backend-url-v2';
    const TIMER_KEY = 'resiliency-demo-timer-v2';
    const TIMER_STATE_KEY = 'resiliency-demo-timer-state-v2';

    // === APP STATE ===
    let records = [];
    let recordIndexMap = {}; // key -> index in records[]
    let lastUpdated = null;
    let backendUrl = '';
    let polling = false;
    let pollInterval = null;

    // Timer state
    let timerStart = null;   // Epoch ms of last start/resume
    let timerElapsed = 0;    // Elapsed ms before last start/resume
    let timerRunning = false;
    let timerInterval = null;

    // --- Timer helpers ---
    function loadTimerState() {
      const state = JSON.parse(localStorage.getItem(TIMER_STATE_KEY) || '{}');
      timerStart = state.timerStart || null;
      timerElapsed = state.timerElapsed || 0;
      timerRunning = state.timerRunning || false;
    }
    function saveTimerState() {
      localStorage.setItem(TIMER_STATE_KEY, JSON.stringify({
        timerStart,
        timerElapsed,
        timerRunning
      }));
    }
    function startTimer() {
      if (timerRunning) return;
      timerRunning = true;
      timerStart = Date.now();
      saveTimerState();
      updateTimerDisplay();
      if (!timerInterval) {
        timerInterval = setInterval(updateTimerDisplay, 1000);
      }
    }
    function pauseTimer() {
      if (!timerRunning) return;
      timerElapsed += Date.now() - timerStart;
      timerStart = null;
      timerRunning = false;
      saveTimerState();
      updateTimerDisplay();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }
    function resetTimer() {
      timerElapsed = 0;
      timerStart = null;
      timerRunning = false;
      saveTimerState();
      updateTimerDisplay();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }
    function getTimerMs() {
      if (timerRunning && timerStart) {
        return timerElapsed + (Date.now() - timerStart);
      }
      return timerElapsed;
    }
    function formatTimer(ms) {
      const total = Math.floor(ms / 1000);
      const hours = Math.floor(total / 3600).toString().padStart(2, '0');
      const mins = Math.floor((total % 3600) / 60).toString().padStart(2, '0');
      const secs = (total % 60).toString().padStart(2, '0');
      return `${hours}:${mins}:${secs}`;
    }
    function updateTimerDisplay() {
      document.getElementById('timer-value').textContent = formatTimer(getTimerMs());
    }

    // --- Records & Storage ---
    function loadRecords() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try { records = JSON.parse(stored); }
        catch { records = []; }
      }
      updateIndexMap();
    }
    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }
    function updateIndexMap() {
      recordIndexMap = {};
      records.forEach((rec, i) => {
        const key = `${rec.pod_name}||${rec.node_name}`;
        recordIndexMap[key] = i;
      });
    }

    // Backend URL helpers
    function loadBackendUrl() {
      backendUrl = localStorage.getItem(BACKEND_URL_KEY) || '';
    }
    function saveBackendUrl(url) {
      backendUrl = url;
      localStorage.setItem(BACKEND_URL_KEY, backendUrl);
    }
    function clearBackendUrl() {
      backendUrl = '';
      localStorage.removeItem(BACKEND_URL_KEY);
      document.getElementById('backend-url-input').value = '';
    }

    function formatTime(val) {
      if (!val || val === 'ERROR') return val;
      try { return new Date(val).toLocaleString(); }
      catch { return val; }
    }

    // Render the status table
    function updateTable() {
      const tbody = document.querySelector('#statustable tbody');
      tbody.innerHTML = '';
      records.forEach(rec => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rec.count}</td>
          <td>${formatTime(rec.datetime)}</td>
          <td class="mono">${rec.pod_name}</td>
          <td class="mono">${rec.node_name}</td>
          <td${rec.response_code === 0 ? ' class="error"' : ''}>${rec.response_code}</td>
          <td>${rec.latency_ms}</td>
        `;
        tbody.appendChild(tr);
      });
      if (lastUpdated) {
        document.getElementById('table-updated').textContent =
          `Last updated: ${new Date(lastUpdated).toLocaleTimeString()}`;
      } else {
        document.getElementById('table-updated').textContent = '';
      }
    }

    function setButtons(start, pause, reset) {
      document.getElementById('start-btn').disabled = !start;
      document.getElementById('pause-btn').disabled = !pause;
      document.getElementById('reset-btn').disabled = !reset;
    }

    function startPolling() {
      if (!backendUrl) return;
      if (polling) return;
      polling = true;
      setButtons(false, true, true);
      pollInterval = setInterval(fetchBackend, 2000);
      startTimer();
    }
    function pausePolling() {
      if (!polling) return;
      polling = false;
      setButtons(true, false, true);
      clearInterval(pollInterval);
      pollInterval = null;
      pauseTimer();
    }
    function resetAll() {
      records = [];
      updateIndexMap();
      saveRecords();
      lastUpdated = null;
      updateTable();
      pausePolling();
      resetTimer();
      // Keep the URL in localStorage and input
      // Don't clear backendUrl here
    }

    // API Polling
    async function fetchBackend() {
      const start = performance.now();
      try {
        const res = await fetch(backendUrl);
        const response_code = res.status;
        const latency_ms = Math.round(performance.now() - start);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        const key = `${data.pod_name}||${data.node_name}`;

        if (key in recordIndexMap) {
          // Increment counter, update response code and latency
          const rec = records[recordIndexMap[key]];
          rec.count += 1;
          rec.response_code = response_code;
          rec.latency_ms = latency_ms;
        } else {
          // New row for new pod/node combo
          records.push({
            count: 1,
            datetime: data.datetime,
            pod_name: data.pod_name,
            node_name: data.node_name,
            response_code: response_code,
            latency_ms: latency_ms
          });
          updateIndexMap();
        }
        saveRecords();
        lastUpdated = Date.now();
        updateTable();
      } catch (e) {
        // Record error as its own key
        const key = `-||-`;
        if (key in recordIndexMap) {
          const rec = records[recordIndexMap[key]];
          rec.count += 1;
          rec.response_code = 0;
          rec.latency_ms = 0;
        } else {
          records.push({
            count: 1,
            datetime: 'ERROR',
            pod_name: '-',
            node_name: '-',
            response_code: 0,
            latency_ms: 0
          });
          updateIndexMap();
        }
        saveRecords();
        lastUpdated = Date.now();
        updateTable();
      }
    }

    // ==== UI EVENTS ====
    document.addEventListener('DOMContentLoaded', () => {
      loadRecords();
      updateTable();
      loadBackendUrl();
      loadTimerState();
      updateTimerDisplay();

      // Show backend URL input always, fill with stored value if available
      document.getElementById('backend-url-input').value = backendUrl;

      setButtons(true, false, true);

      document.getElementById('start-btn').onclick = () => {
        if (!backendUrl) {
          alert('Please provide a valid Backend URL first.');
          return;
        }
        startPolling();
      };
      document.getElementById('pause-btn').onclick = () => {
        pausePolling();
      };
      document.getElementById('reset-btn').onclick = () => {
        resetAll();
      };

      // Backend URL form: always visible, only saves
      document.getElementById('backend-url-form').onsubmit = function (e) {
        e.preventDefault();
        const url = document.getElementById('backend-url-input').value.trim();
        if (!url) return;
        saveBackendUrl(url);
        // Do not auto-start polling
      };

      document.getElementById('url-reset-btn').onclick = function () {
        clearBackendUrl();
      };
    });

  </script>
</body>
</html>
