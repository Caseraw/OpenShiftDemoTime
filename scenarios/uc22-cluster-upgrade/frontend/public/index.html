<!DOCTYPE html>
<html>
<head>
  <title>App Resiliency Demo</title>
  <meta charset="utf-8">
  <style>
    :root {
      --accent: #1d72b8;
      --bg: #f5f7fa;
      --header: #ffffffcc;
      --shadow: 0 2px 12px #0001;
      --error: #e63946;
      --font: 'Segoe UI', 'Arial', sans-serif;
    }
    html, body {
      background: var(--bg);
      font-family: var(--font);
      margin: 0; padding: 0;
    }
    .container {
      max-width: 1200px;
      min-width: 340px;
      margin: 2.5em auto 1em auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 2.5em 2em 2em 2em;
    }
    h2 {
      margin-top: 0;
      font-size: 2.1em;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--accent);
      text-shadow: 0 1px 0 #fff;
      margin-bottom: 0.2em;
    }
    #reset-btn {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      padding: 0.6em 1.6em;
      font-size: 1em;
      margin-bottom: 1.2em;
      box-shadow: 0 2px 6px #0002;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #reset-btn:hover {
      background: #174c7c;
    }
    .timestamp {
      color: #888;
      font-size: 0.96em;
      float: right;
      font-style: italic;
      margin-bottom: 0.8em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--header);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      table-layout: auto;
    }
    th {
      background: var(--accent);
      color: #fff;
      font-size: 1.03em;
      letter-spacing: 0.02em;
      font-weight: 700;
      padding: 12px 8px;
      border-bottom: 2px solid #ddd4;
      user-select: none;
    }
    td {
      padding: 11px 8px;
      font-size: 1.04em;
      border-bottom: 1px solid #eee;
      word-break: break-word;
    }
    tr:nth-child(even) td {
      background: #f2f8fc;
    }
    td.mono, th.mono { font-family: 'Fira Mono', 'Consolas', monospace; font-size: 0.99em;}
    td.error { color: var(--error); font-weight: bold;}
    @media (max-width: 700px) {
      .container { padding: 1em; }
      th, td { font-size: 0.96em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>App Resiliency Demo</h2>
    <button id="reset-btn">Reset Table</button>
    <div class="timestamp" id="table-updated"></div>
    <table id="statustable">
      <thead>
        <tr>
          <th>Count</th>
          <th>Time</th>
          <th class="mono">Pod Name</th>
          <th class="mono">Node Name</th>
          <th>Response Code</th>
          <th>Latency (ms)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    // === CONFIGURATION ===
    const BACKEND_URL = '<BACKEND_API_URL>'; // <-- set your backend endpoint here
    const STORAGE_KEY = 'resiliency-demo-records-simple';

    // === APP STATE ===
    let records = [];
    let recordIndexMap = {}; // key -> index in records[]
    let lastUpdated = null;

    // Load and save to browser storage
    function loadRecords() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try { records = JSON.parse(stored); }
        catch { records = []; }
      }
      updateIndexMap();
    }
    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }
    function updateIndexMap() {
      recordIndexMap = {};
      records.forEach((rec, i) => {
        const key = `${rec.pod_name}||${rec.node_name}`;
        recordIndexMap[key] = i;
      });
    }

    // Date formatting
    function formatTime(val) {
      if (!val || val === 'ERROR') return val;
      try { return new Date(val).toLocaleString(); }
      catch { return val; }
    }

    // Renders the status table
    function updateTable() {
      const tbody = document.querySelector('#statustable tbody');
      tbody.innerHTML = '';
      records.forEach(rec => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rec.count}</td>
          <td>${formatTime(rec.datetime)}</td>
          <td class="mono">${rec.pod_name}</td>
          <td class="mono">${rec.node_name}</td>
          <td${rec.response_code === 0 ? ' class="error"' : ''}>${rec.response_code}</td>
          <td>${rec.latency_ms}</td>
        `;
        tbody.appendChild(tr);
      });
      if (lastUpdated) {
        document.getElementById('table-updated').textContent =
          `Last updated: ${new Date(lastUpdated).toLocaleTimeString()}`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadRecords();
      updateTable();

      document.getElementById('reset-btn').onclick = () => {
        records = [];
        updateIndexMap();
        saveRecords();
        updateTable();
      };
    });

    // === API Polling ===
    setInterval(async () => {
      const start = performance.now();
      try {
        const res = await fetch(BACKEND_URL);
        const response_code = res.status;
        const latency_ms = Math.round(performance.now() - start);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        const key = `${data.pod_name}||${data.node_name}`;

        if (key in recordIndexMap) {
          // Increment counter, update response code and latency, but do NOT create a new row.
          const rec = records[recordIndexMap[key]];
          rec.count += 1;
          rec.response_code = response_code;
          rec.latency_ms = latency_ms;
          // Only keep the earliest time for display (not overwritten).
        } else {
          // New row for new pod/node combo.
          records.push({
            count: 1,
            datetime: data.datetime,
            pod_name: data.pod_name,
            node_name: data.node_name,
            response_code: response_code,
            latency_ms: latency_ms
          });
          updateIndexMap();
        }
        saveRecords();
        lastUpdated = Date.now();
        updateTable();
      } catch (e) {
        // Record error as its own key
        const key = `-||-`;
        if (key in recordIndexMap) {
          const rec = records[recordIndexMap[key]];
          rec.count += 1;
          rec.response_code = 0;
          rec.latency_ms = 0;
        } else {
          records.push({
            count: 1,
            datetime: 'ERROR',
            pod_name: '-',
            node_name: '-',
            response_code: 0,
            latency_ms: 0
          });
          updateIndexMap();
        }
        saveRecords();
        lastUpdated = Date.now();
        updateTable();
      }
    }, 2000);
  </script>
</body>
</html>
