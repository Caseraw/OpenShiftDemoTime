<!DOCTYPE html>
<html>
<head>
  <title>App Resiliency Demo</title>
  <meta charset="utf-8">
  <style>
    :root {
      --accent: #1d72b8;
      --bg: #f5f7fa;
      --header: #ffffffcc;
      --shadow: 0 2px 12px #0001;
      --error: #e63946;
      --success: #2ec4b6;
      --active-bg: #e3f7ff;
      --font: 'Segoe UI', 'Arial', sans-serif;
    }
    html, body {
      background: var(--bg);
      font-family: var(--font);
      margin: 0; padding: 0;
    }
    .container {
      max-width: 1200px;
      min-width: 340px;
      margin: 2.5em auto 1em auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 2.5em 2em 2em 2em;
    }
    h2 {
      margin-top: 0;
      font-size: 2.1em;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--accent);
      text-shadow: 0 1px 0 #fff;
      margin-bottom: 0.2em;
    }
    #reset-btn {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      padding: 0.6em 1.6em;
      font-size: 1em;
      margin-bottom: 1.2em;
      box-shadow: 0 2px 6px #0002;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #reset-btn:hover {
      background: #174c7c;
    }
    .top-controls {
      display: flex;
      gap: 1.5em;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.2em;
      flex-wrap: wrap;
    }
    #filter-input {
      font-size: 1em;
      padding: 0.5em 1em;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      min-width: 160px;
      background: #fafcff;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--header);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      table-layout: auto;
    }
    th {
      background: var(--accent);
      color: #fff;
      font-size: 1.03em;
      letter-spacing: 0.02em;
      font-weight: 700;
      padding: 12px 8px;
      border-bottom: 2px solid #ddd4;
      user-select: none;
      cursor: pointer;
      position: relative;
    }
    th.sort-asc::after {
      content: " â–²";
      font-size: 0.88em;
    }
    th.sort-desc::after {
      content: " â–¼";
      font-size: 0.88em;
    }
    td {
      padding: 11px 8px;
      font-size: 1.04em;
      border-bottom: 1px solid #eee;
      word-break: break-word;
    }
    tr:nth-child(even) td {
      background: #f2f8fc;
    }
    tr.active-row td {
      background: var(--active-bg) !important;
      border-left: 4px solid var(--accent);
    }
    .active-dot {
      font-size: 1.3em;
      color: var(--success);
      text-align: center;
      width: 2em;
    }
    tr:hover td {
      background: #eaf3fb;
    }
    td.mono, th.mono { font-family: 'Fira Mono', 'Consolas', monospace; font-size: 0.99em;}
    td.error { color: var(--error); font-weight: bold;}
    .timestamp {
      color: #888;
      font-size: 0.96em;
      float: right;
      font-style: italic;
      margin-bottom: 0.8em;
    }
    @media (max-width: 700px) {
      .container { padding: 1em; }
      th, td { font-size: 0.96em; }
      .top-controls { flex-direction: column; gap: 0.6em; align-items: flex-start;}
      .active-dot { font-size: 1.2em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>App Resiliency Demo</h2>
    <div class="top-controls">
      <div>
        <button id="reset-btn">Reset Table</button>
      </div>
      <input type="text" id="filter-input" placeholder="Filter by any value...">
      <div class="timestamp" id="table-updated"></div>
    </div>
    <table id="statustable">
      <thead>
        <tr>
          <th style="width:2em"></th>
          <th data-col="count">Count</th>
          <th data-col="datetime">Time</th>
          <th data-col="pod_name" class="mono">Pod Name</th>
          <th data-col="node_name" class="mono">Node Name</th>
          <th data-col="response_code">Response Code</th>
          <th data-col="latency_ms">Latency (ms)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    // === CONFIGURATION ===
    const BACKEND_URL = '<BACKEND_API_URL>'; // <-- set your backend endpoint here
    const STORAGE_KEY = 'resiliency-demo-records';

    // === APP STATE ===
    let recordMap = {};
    let lastRowKey = null;
    let lastUpdated = null;
    let sortCol = 'last_seen'; // Always default to "latest hit on top"
    let sortDir = 'desc';      // Descending (latest first)
    let filterVal = '';

    // Util: Update 'last_seen' on a record
    function touchRecord(key) {
      recordMap[key].last_seen = Date.now();
    }

    // Load and save to browser storage
    function loadRecords() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try { recordMap = JSON.parse(stored); }
        catch { recordMap = {}; }
      }
    }
    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(recordMap));
    }

    // Date formatting
    function formatTime(val) {
      if (!val || val === 'ERROR') return val;
      try { return new Date(val).toLocaleString(); }
      catch { return val; }
    }

    // Sorting function by column and direction
    function getSortFn(col, dir) {
      return (a, b) => {
        let av = a[col], bv = b[col];
        if (col === 'datetime' || col === 'last_seen') {
          av = new Date(av || 0).getTime();
          bv = new Date(bv || 0).getTime();
        }
        if (typeof av === 'string') av = av.toLowerCase();
        if (typeof bv === 'string') bv = bv.toLowerCase();
        if (av < bv) return dir === 'asc' ? -1 : 1;
        if (av > bv) return dir === 'asc' ? 1 : -1;
        return 0;
      };
    }

    // Renders the status table (now with "active row" marker)
    function updateTable() {
      const tbody = document.querySelector('#statustable tbody');
      tbody.innerHTML = '';
      let records = Object.values(recordMap);

      // Filtering
      if (filterVal) {
        const f = filterVal.trim().toLowerCase();
        records = records.filter(rec =>
          Object.values(rec).some(val =>
            String(val).toLowerCase().includes(f)
          )
        );
      }

      // Always sort by last_seen DESC (latest-hit row on top)
      records = records.sort(getSortFn('last_seen', 'desc'));

      records.forEach((rec) => {
        const key = `${rec.pod_name}||${rec.node_name}`;
        const tr = document.createElement('tr');
        tr.className = 'status-row' + (key === lastRowKey ? ' active-row' : '');
        tr.innerHTML = `
          <td class="active-dot">${key === lastRowKey ? 'ðŸŸ¢' : ''}</td>
          <td>${rec.count}</td>
          <td>${formatTime(rec.datetime)}</td>
          <td class="mono">${rec.pod_name}</td>
          <td class="mono">${rec.node_name}</td>
          <td${rec.response_code === 0 ? ' class="error"' : ''}>${rec.response_code}</td>
          <td>${rec.latency_ms}</td>
        `;
        tbody.appendChild(tr);
      });

      if (lastUpdated) {
        document.getElementById('table-updated').textContent =
          `Last updated: ${new Date(lastUpdated).toLocaleTimeString()}`;
      }
      // Update header sort indicators
      document.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.col === sortCol) {
          th.classList.add('sort-' + sortDir);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadRecords();
      updateTable();

      document.getElementById('reset-btn').onclick = () => {
        recordMap = {};
        saveRecords();
        updateTable();
      };

      // Filter event
      document.getElementById('filter-input').oninput = (e) => {
        filterVal = e.target.value;
        updateTable();
      };

      // Sorting events
      document.querySelectorAll('th[data-col]').forEach(th => {
        th.onclick = () => {
          const col = th.dataset.col;
          if (sortCol === col) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            sortCol = col;
            sortDir = (col === 'count' || col === 'response_code' || col === 'latency_ms') ? 'desc' : 'asc';
          }
          updateTable();
        };
      });
    });

    // === API Polling ===
    setInterval(async () => {
      const start = performance.now();
      try {
        const res = await fetch(BACKEND_URL);
        const response_code = res.status;
        const latency_ms = Math.round(performance.now() - start);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        const key = `${data.pod_name}||${data.node_name}`;
        lastRowKey = key;
        if (recordMap[key]) {
          recordMap[key].count += 1;
          recordMap[key].response_code = response_code;
          recordMap[key].latency_ms = latency_ms;
          touchRecord(key);
        } else {
          recordMap[key] = {
            count: 1,
            datetime: data.datetime,
            pod_name: data.pod_name,
            node_name: data.node_name,
            response_code: response_code,
            latency_ms: latency_ms,
            last_seen: Date.now()
          };
        }
        saveRecords();
        lastUpdated = Date.now();

        // After a new call, always show latest-hit row on top
        sortCol = 'last_seen';
        sortDir = 'desc';
        updateTable();
      } catch (e) {
        const key = `-||-`;
        const latency_ms = Math.round(performance.now() - start);
        lastRowKey = key;
        if (recordMap[key]) {
          recordMap[key].count += 1;
          recordMap[key].response_code = 0;
          recordMap[key].latency_ms = latency_ms;
          touchRecord(key);
        } else {
          recordMap[key] = {
            count: 1,
            datetime: 'ERROR',
            pod_name: '-',
            node_name: '-',
            response_code: 0,
            latency_ms: latency_ms,
            last_seen: Date.now()
          };
        }
        saveRecords();
        lastUpdated = Date.now();
        // After a new call, always show latest-hit row on top
        sortCol = 'last_seen';
        sortDir = 'desc';
        updateTable();
      }
    }, 2000);
  </script>
</body>
</html>
